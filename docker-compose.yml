# New-API Docker Compose Configuration (Conversation Edition v1.0.0)
#
# äºŒå¼€ç‰ˆæœ¬è¯´æ˜ï¼š
#   - æ–°å¢å®Œæ•´çš„å¯¹è¯å†…å®¹è®°å½•åŠŸèƒ½
#   - æ–°å¢å¯¹è¯å½’æ¡£å’Œè‡ªåŠ¨ç»´æŠ¤
#   - æ–°å¢æ‰¹é‡åˆ é™¤å’Œé«˜çº§ç­›é€‰
#   - æ€§èƒ½ä¼˜åŒ–ï¼ˆæŸ¥è¯¢é€Ÿåº¦æå‡5-10å€ï¼‰
#
# Quick Start:
#   1. ä¿®æ”¹å¯†ç ï¼ˆSESSION_SECRET, POSTGRES_PASSWORD, rediså¯†ç ï¼‰
#   2. docker-compose up -d
#   3. è®¿é—® http://localhost:3000
#   4. é»˜è®¤è´¦å·ï¼šroot / 123456ï¼ˆè¯·ç«‹å³ä¿®æ”¹ï¼ï¼‰
#
# ä½¿ç”¨ MySQL æ›¿ä»£ PostgreSQL:
#   1. æ³¨é‡Šæ‰ postgres æœåŠ¡å’Œç¬¬30è¡Œçš„ SQL_DSN
#   2. å–æ¶ˆæ³¨é‡Š mysql æœåŠ¡å’Œç¬¬31è¡Œçš„ SQL_DSN
#   3. å–æ¶ˆæ³¨é‡Š depends_on ä¸­çš„ mysql (ç¬¬52è¡Œ)
#   4. å–æ¶ˆæ³¨é‡Š volumes ä¸­çš„ mysql_data (ç¬¬94è¡Œ)
#
# âš ï¸  é‡è¦ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰å¿…é¡»ä¿®æ”¹æ‰€æœ‰é»˜è®¤å¯†ç ï¼

version: '3.8'

services:
  new-api:
    # ğŸ‰ äºŒå¼€ç‰ˆæœ¬é•œåƒï¼ˆåŒ…å«å¯¹è¯è®°å½•åŠŸèƒ½ï¼‰
    image: zhang/new-api:v1.0.0-conversation
    container_name: new-api
    restart: unless-stopped
    command: --log-dir /app/logs

    ports:
      - "3000:3000"

    volumes:
      - ./data:/data
      - ./logs:/app/logs

    environment:
      # æ•°æ®åº“é…ç½®ï¼ˆå¿…é¡»ä¿®æ”¹å¯†ç ï¼ï¼‰
      - SQL_DSN=postgresql://root:123456@postgres:5432/new-api # âš ï¸ ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹å¯†ç ï¼
#      - SQL_DSN=root:123456@tcp(mysql:3306)/new-api  # MySQLé…ç½®ï¼Œå–æ¶ˆæ³¨é‡Šå¹¶æ³¨é‡Šä¸Šä¸€è¡Œ

      # Redis ç¼“å­˜
      - REDIS_CONN_STRING=redis://redis

      # æ—¶åŒºè®¾ç½®
      - TZ=Asia/Shanghai

      # åŸºç¡€åŠŸèƒ½å¼€å…³
      - ERROR_LOG_ENABLED=true
      - BATCH_UPDATE_ENABLED=true

      # ä¼šè¯å¯†é’¥ï¼ˆå¤šæœºéƒ¨ç½²å¿…é¡»è®¾ç½®ï¼Œå•æœºä¹Ÿå»ºè®®è®¾ç½®ï¼‰
      - SESSION_SECRET=random-session-secret-change-me-in-production

      # ============================================
      # ğŸ†• å¯¹è¯è®°å½•åŠŸèƒ½é…ç½®ï¼ˆäºŒå¼€æ–°å¢ï¼‰
      # ============================================

      # å¯ç”¨å¯¹è¯è®°å½•åŠŸèƒ½ï¼ˆtrue/falseï¼‰
      - CONVERSATION_LOG_ENABLED=true

      # è‡ªåŠ¨å½’æ¡£å¤©æ•°ï¼ˆå½’æ¡£å¤šå°‘å¤©å‰çš„å¯¹è¯åˆ°å½’æ¡£è¡¨ï¼‰
      - CONVERSATION_ARCHIVE_DAYS=30

      # è‡ªåŠ¨æ¸…ç†å¤©æ•°ï¼ˆåˆ é™¤å¤šå°‘å¤©å‰çš„å½’æ¡£æ•°æ®ï¼‰
      - CONVERSATION_CLEANUP_DAYS=365

      # ============================================
      # å…¶ä»–å¯é€‰é…ç½®
      # ============================================

      # æµæ¨¡å¼è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
#      - STREAMING_TIMEOUT=300

      # æ•°æ®åº“åŒæ­¥é¢‘ç‡ï¼ˆç§’ï¼‰
#      - SYNC_FREQUENCY=60

      # Google Analytics
#      - GOOGLE_ANALYTICS_ID=G-XXXXXXXXXX

      # Umami ç»Ÿè®¡
#      - UMAMI_WEBSITE_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
#      - UMAMI_SCRIPT_URL=https://analytics.umami.is/script.js

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
#      mysql:  # MySQL ä½¿ç”¨æ—¶å–æ¶ˆæ³¨é‡Š
#        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:3000/api/status | grep -o '\"success\":\\s*true' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  redis:
    image: redis:7-alpine
    container_name: new-api-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

  postgres:
    image: postgres:15-alpine
    container_name: new-api-postgres
    restart: unless-stopped

    environment:
      POSTGRES_USER: root
      POSTGRES_PASSWORD: 123456  # âš ï¸ ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹å¯†ç ï¼
      POSTGRES_DB: new-api

    volumes:
      - pg_data:/var/lib/postgresql/data

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U root"]
      interval: 10s
      timeout: 5s
      retries: 5

#    ports:
#      - "5432:5432"  # å¦‚éœ€ä»å¤–éƒ¨è®¿é—® PostgreSQLï¼Œå–æ¶ˆæ³¨é‡Š

  # MySQL æ•°æ®åº“ï¼ˆå¯é€‰ï¼Œä¸ PostgreSQL äºŒé€‰ä¸€ï¼‰
#  mysql:
#    image: mysql:8.2
#    container_name: new-api-mysql
#    restart: unless-stopped
#
#    environment:
#      MYSQL_ROOT_PASSWORD: 123456  # âš ï¸ ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹å¯†ç ï¼
#      MYSQL_DATABASE: new-api
#
#    command: >
#      --character-set-server=utf8mb4
#      --collation-server=utf8mb4_unicode_ci
#      --default-authentication-plugin=mysql_native_password
#
#    volumes:
#      - mysql_data:/var/lib/mysql
#
#    healthcheck:
#      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p123456"]
#      interval: 10s
#      timeout: 5s
#      retries: 5
#
#    ports:
#      - "3306:3306"  # å¦‚éœ€ä»å¤–éƒ¨è®¿é—® MySQLï¼Œå–æ¶ˆæ³¨é‡Š

volumes:
  pg_data:
    driver: local
  redis_data:
    driver: local
#  mysql_data:  # MySQL ä½¿ç”¨æ—¶å–æ¶ˆæ³¨é‡Š
#    driver: local

# ============================================
# ğŸ‰ äºŒå¼€ç‰ˆæœ¬è¯´æ˜
# ============================================
#
# ç‰ˆæœ¬ï¼šv1.0.0-conversation
# ä½œè€…ï¼šZhang
# æ—¥æœŸï¼š2025-01
#
# æ–°å¢åŠŸèƒ½ï¼š
#   âœ… å®Œæ•´çš„å¯¹è¯å†…å®¹è®°å½•ï¼ˆè¯·æ±‚+å“åº”ï¼‰
#   âœ… åå°ç®¡ç†ç•Œé¢ï¼ˆæŒ‰ç”¨æˆ·ã€æ¨¡å‹ã€æ—¶é—´ç­›é€‰ï¼‰
#   âœ… æ‰¹é‡åˆ é™¤å’ŒæŒ‰æ¡ä»¶æ‰¹é‡åˆ é™¤
#   âœ… è‡ªåŠ¨å½’æ¡£ï¼ˆä¸»è¡¨ä¿æŒè½»é‡ï¼Œæ€§èƒ½æå‡5-10å€ï¼‰
#   âœ… æ•°æ®å‹ç¼©ï¼ˆèŠ‚çœ50-70%å­˜å‚¨ç©ºé—´ï¼‰
#   âœ… è‡ªåŠ¨ç»´æŠ¤ä»»åŠ¡ï¼ˆæ¯æ—¥å½’æ¡£ã€æ¯å‘¨æ¸…ç†ã€æ¯æœˆä¼˜åŒ–ï¼‰
#   âœ… 5ä¸ªæ–°å¢ API æ¥å£
#
# é…ç½®è¯´æ˜ï¼š
#   CONVERSATION_LOG_ENABLED: å¯ç”¨å¯¹è¯è®°å½•åŠŸèƒ½
#   CONVERSATION_ARCHIVE_DAYS: å½’æ¡£å¤©æ•°ï¼ˆé»˜è®¤30å¤©ï¼‰
#   CONVERSATION_CLEANUP_DAYS: æ¸…ç†å½’æ¡£å¤©æ•°ï¼ˆé»˜è®¤365å¤©ï¼‰
#
# ä½¿ç”¨æ–‡æ¡£ï¼š
#   - README_CONVERSATION_FEATURE.md - å®Œæ•´åŠŸèƒ½è¯´æ˜
#   - CONVERSATION_FEATURE_README.md - éƒ¨ç½²å’Œä½¿ç”¨æ–‡æ¡£
#   - PERFORMANCE_OPTIMIZATION_GUIDE.md - æ€§èƒ½ä¼˜åŒ–æŒ‡å—
#   - DEPLOYMENT_CHECKLIST.md - éƒ¨ç½²æ£€æŸ¥æ¸…å•
#
# ============================================
# ä½¿ç”¨è¯´æ˜
# ============================================
#
# 1. ç”Ÿæˆéšæœºå¯†é’¥ï¼ˆé‡è¦ï¼ï¼‰ï¼š
#    openssl rand -hex 32
#    ç„¶åæ›¿æ¢ SESSION_SECRET çš„å€¼
#
# 2. å¯åŠ¨æœåŠ¡ï¼š
#    docker-compose up -d
#
# 3. æŸ¥çœ‹æ—¥å¿—ï¼š
#    docker-compose logs -f new-api
#
# 4. åœæ­¢æœåŠ¡ï¼š
#    docker-compose down
#
# 5. æ›´æ–°é•œåƒï¼š
#    docker-compose pull
#    docker-compose up -d
#
# 6. å¤‡ä»½æ•°æ®åº“ï¼š
#    docker-compose exec postgres pg_dump -U root new-api > backup.sql
#
# 7. æ¢å¤æ•°æ®åº“ï¼š
#    cat backup.sql | docker-compose exec -T postgres psql -U root new-api
#
# 8. è®¿é—®ç®¡ç†åå°ï¼š
#    http://localhost:3000
#    é»˜è®¤è´¦å·ï¼šroot / 123456ï¼ˆè¯·ç«‹å³ä¿®æ”¹ï¼ï¼‰
#
# 9. å¯¹è¯è®°å½•ç®¡ç†ï¼š
#    http://localhost:3000/conversation
#    ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
#
# 10. ç›‘æ§è¡¨å¤§å°ï¼š
#     curl http://localhost:3000/api/conversation/table_stats \
#       -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
#
# ============================================
# æ•…éšœæ’æŸ¥
# ============================================
#
# é—®é¢˜1ï¼šæ— æ³•å¯åŠ¨
#   è§£å†³ï¼šæ£€æŸ¥ç«¯å£3000æ˜¯å¦è¢«å ç”¨
#   lsof -i :3000
#
# é—®é¢˜2ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥
#   è§£å†³ï¼šæ£€æŸ¥æ•°æ®åº“å®¹å™¨æ˜¯å¦æ­£å¸¸å¯åŠ¨
#   docker-compose ps
#   docker-compose logs postgres
#
# é—®é¢˜3ï¼šå¯¹è¯æœªè¢«è®°å½•
#   è§£å†³ï¼šæ£€æŸ¥ CONVERSATION_LOG_ENABLED æ˜¯å¦ä¸º true
#   docker-compose exec new-api env | grep CONVERSATION
#
# é—®é¢˜4ï¼šè¡¨å¤ªå¤§
#   è§£å†³ï¼šæ‰‹åŠ¨å½’æ¡£å†å²æ•°æ®
#   curl -X POST http://localhost:3000/api/conversation/archive \
#     -H "Authorization: Bearer TOKEN" \
#     -d '{"days": 30, "batch_size": 1000}'
#
